<?xml version="1.0" encoding="UTF-8"?>
<html>
    <head>
        <title>智能客服机器人</title>
            <script src="./js/vue.global.js"></script>
            <link rel="stylesheet" href="css/bootstrap.css" />
            <!--CSS实现-->
            <style>
                body{
                    background-color: #f7f7f7;
                    background-image:url();
                    background-size:cover;
                }
                .square{ 
                    position: absolute; /*绝对位置*/
                    top: 46.2%;
                    left: 34%;
                    transform: translate(-50%, -50%);
                    border: 4px solid #007bff65;
                    border-style:groove;
                    border-radius: 9px;
                    padding: 8px 5px 10px 10px;
                    width: 1000px;
                    height: 825px;
                    overflow: auto; /*实现窗口滚动*/
                }
                .square_image {
                    background-image:url("./picture/paper_d.jpg");
                    position: absolute;
                    top: 46.2%;
                    left: 34%;
                    transform: translate(-50%, -50%);
                    width: 1000px;
                    height: 825px;
                    opacity: 0.45; /* 设置伪元素的透明度 */
                }
                .square p{
                    position: relative;
                    padding: 10px 10px 2px 70px;
                    font-size: 35px;
                    overflow: hidden; /* 清除浮动元素造成的高度塌陷问题 */
                    line-height: 1.2; 
                    font-family: "Times New Roman", Times, serif;
                    color: #4b4b4bbf;
                }
                .square p::after{
                    /*生成分隔线*/
                    content: ""; /*伪元素*/
                    position: absolute;
                    left: 0;
                    bottom: -9px;
                    width: 100%;
                    height: 10px;
                    background-color: rgb(0, 0, 0);
                    z-index: -1;
                }
                .message_image {
                    padding: 0px 5px 0px 5px;
                    float:right;
                    width: 68px; 
                    margin-right: 10px; /* 调整图片与文本之间的间距 */
                }
                .inputter{
                    position: absolute;
                    top: 95.5%;
                    left: 34%;
                    transform: translate(-50%, -50%);
                    width: 1000px;
                    height: 60px;
                    font-size: 35px;
                    color: #4b4b4bbf;
                    font-family: "Times New Roman", Times, serif;
                    border-radius: 6px;
                    padding: 12px;
                    border: 4px solid #007bff7e;
                    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.495);
                }
                .submission{
                    position: absolute;
                    top: 92.2%;
                    left: 61.5%;
                    width: 59px;
                    height: 59px;
                    background-image: url(./picture/send.png);
                    background-size: cover;
                    background-position: center;
                    background-repeat: no-repeat;
                    border-radius: 8px;
                }
                .button_set {
                    position: absolute;
                    top: 71.2%;
                    left: 84.5%;
                    transform: translate(-50%, -50%);
                    display: flex;
                    flex-direction: column; /*flex定义按钮组排版*/
                }
                .custom_button {
                    width: 350px;
                    height: 45px;
                    background-color: #ffffff00;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.539);
                    color: #007bff7e;
                    border: solid;
                    border-radius: 3px;
                    border-color: #007bff7e;
                    padding: 10px 20px;
                    font-size: 16px;
                    margin:5px;
                    transition: background-color 0.3s, color 0.3s; /* 添加过渡效果 */
                    cursor: pointer;
                }
                .custom_button:hover{
                     /*悬停改变按钮样式*/
                    color: #ffffff;
                    border-color: #ffffff00;
                    background-color:#007bff7e;
                }
                .vertical_line {
                    position: absolute;
                    top: 50%;
                    left: 68.5%;
                    transform: translate(-50%, -50%);
                    width: 1.3px;
                    height: 98%;
                    border-color: #007bff7e;
                    border-style: groove;
                }
                .container{
                    position: absolute;
                    top: 71.5%;
                    left: 84.4%;
                    transform: translate(-50%, -50%);
                    border: 3px solid #007bff7e;
                    border-radius: 9px;
                    border-style:groove;
                    width: 410px;
                    height: 380px;
                }
                .container p{
                    margin-bottom: 132px;
                    word-spacing: 100px;
                    white-space: pre;
                    font-weight: bold;
                    font-family: "Times New Roman", Times, serif;
                    font-size: 32px;
                    padding: 5px 0px 0px 3px;
                    color: #4b4b4bbf;
                }
                .changer{
                    position: absolute;
                    top: 92.6%;
                    left: 88.6%;
                    transform: translate(-50%, -50%);
                    background-image: url(./picture/change.png);
                    background-size: cover;
                    background-position: center;
                    background-repeat: no-repeat;
                    width: 38px;
                    height: 38px;
                }
                .markdown{
                    position: absolute;
                    top:23.5%;
                    left:84.4%;
                    transform: translate(-50%, -50%);
                    border: 3px solid #007bff7e;
                    border-radius: 9px;
                    border-style:groove;
                    width: 410px;
                    height: 413px;
                    overflow: auto; 
                }
                .markdown p{
                    font-weight: bold;
                    font-family: "Times New Roman", Times, serif;
                    font-size: 20px;
                    padding: 4px 0px 0px 4px;
                    color: #4b4b4bbf;
                }
                .expander{
                    width: 100x;
                    height: 32px;
                    background-color: #ffffff00;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.539);
                    color: #007bff7e;
                    border: solid;
                    border-radius: 2px;
                    border-color: #007bff7e;
                    font-size: 16px;
                    transition: background-color 0.3s, color 0.3s; /* 添加过渡效果 */
                    cursor: pointer;
                }
                .expander:hover{
                    color: #ffffff;
                    border-color: #ffffff00;
                    background-color:#007bff7e;
                }
                .hr{
                    border:1px groove #007bff7e;
                }
            </style>
    </head>

    <body>
        <div id="app">

            <!--背景-->
            <div class="square_image" alt="Background Image"></div>
            <!--装饰性竖线-->
            <div class="vertical_line"></div>
            
            <!--Markdown显示框-->
            <div class="markdown">
                <p>.md参考</p>   
                <hr class="hr">
                <!-- 文本和图片对应展示 -->
                <div v-for="(item,index) in mdContent" :key="item.id">
                    <!-- 添加按钮 -->
                    <button class="expander" @click="toggleExpand(item)">{{item.filename}}</button> 
                    <div class="mdText" v-show="item.expanded">
                        <p v-html="addLineBreaks(item.text)"></p>
                    </div>
                    <div v-for="image in item.image" :key="image" v-show="item.expanded">
                        <img :src="basePath + image" alt="">
                    </div>
                    <!-- 在每个按钮组之后生成分隔线 -->
                    <hr class="hr" v-if="(index + 1) % mdFileCount == 0">
                </div>
            </div>

            <!--回答显示文本框-->
            <div class="square">
                <!--问答信息-->
                <div class="message" v-for="message in messages" :key="message.id">
                    <img class="message_image" :src="message.imageUrl" alt=Image">
                    <p v-html="addLineBreaks(message.text)"></p>
                </div>
            </div>
            
            <!--“换一批”框架-->
            <div class="container">
                <p>猜你想问:</p>
                <p></p>
                <p>&nbsp;&nbsp;换一批</p>
                <button class="changer" @click="getChangeCircle()"></button>
            </div>

            <!--“换一批”按钮组-->
            <div class="button_set">
                <button class="custom_button" v-for="button in buttons" 
                v-bind:key="button.id" @click="fill(button.buttonText)">{{ button.label }}</button>
            </div>

            <!--键入框监听-->
            <form action="./receive.py" method="post">
                    <input class="inputter" v-model="inputText" type="text" placeholder="有什么可以帮助您的呢？">
                    <button class="submission" v-on:click="submit"></button>
            </form>
        </div>
    </body>

    <script>
        const mydata={
            data() {  
                return{

                    //////////////////////////////
                    basePath: 'file:///C:/Users/LENOVO/Desktop/Project/',//这里需要修改
                    //////////////////////////////

                    mdFileCount:0,
                    inputText:'',
                    responseText:'',
                    //markdownText:[],
                    //markdownImages:[],
                    markdownContents:[],
                    messages: [],
                    mdTexts:[],
                    mdImage:[],
                    mdContent:[],
                    buttonsStore:
                    [
                        //在每组label和buttonText中输入一致的文本
                        { id: 1, label: '我测试长度我测试长度我测试长度我度我度', buttonText: '19字' },
                        { id: 2, label: '按钮2', buttonText: '文本2' },
                        { id: 3, label: '按钮3', buttonText: '文本3' },
                        { id: 4, label: '按钮2', buttonText: '文本2' },
                        { id: 5, label: '按钮2', buttonText: '文本2' },
                        { id: 6, label: '我测试长度', buttonText: '16f字' },
                        { id: 7, label: '按钮2gd', buttonText: '文本f2' },
                        { id: 8, label: '按钮3s', buttonText: '文本3g' },
                        { id: 9, label: '按钮f2', buttonText: '文本2a' },
                        { id: 10, label: '按钮2k', buttonText: '文本s2' },
                        { id: 11, label: '按钮3', buttonText: '文本3' },
                        { id: 12, label: '按钮2', buttonText: '文本2' },
                        { id: 13, label: '按钮2', buttonText: '文本2' },
                        { id: 14, label: '我测试长度', buttonText: '16f字' },
                        { id: 15, label: '按钮2gd', buttonText: '文本f2' },
                    ],
                    buttons:[],     //处理后的新数据，用于输出
                    timeStart: 0,   //截取第几组的起始参数
                    timeEnd: 1,     //截取第几组的结束参数
                    group: 0,       //默认为0组
                    num: 5,         //每页展示列表的数量
                    clickNum: 0,    //点击的次数
                }
            },

            mounted() {
                    this.interceptingData();
                    try {
                    } catch (error) {
                    // 处理错误
                    console.error('Error during mounted hook:', error);
                }
            },

            methods:{

                //切换md文件的展开和收起状态
                toggleExpand(item) {
                    item.expanded = !item.expanded;
                    },

                //添加空行
                addLineBreaks(text) {
                    return text.replace(/\n/g, '<br>');
                    },
                
                // “换一批”总函数
                getChangeCircle() {
                    if (this.buttonsStore.length > 5 && this.buttonsStore.length > this.num){
                        this.sourceListlen();   //点击的时候获取分为几组
                        this.autoIncre();       //每点击一次记录点击次数
                        this.clear();
                        this.interceptingData();
                        }
                    },

                // “换一批”分组函数
                //计算数据的长度，共分为几组，如果不能整除则加1
                sourceListlen() {
                    var len = this.buttonsStore.length; //获取源数据的长度
                    this.group = len / this.num;
                    if (len % this.num != 0) {
                        this.group = parseInt(this.group) + 1;
                    }
                    },
                    
                //“换一批”重新计数函数
                //计算将点击次数和开始截取的参数清空, 如果点击此时大于当前数据的组数，则重新开始计数
                clear() {
                    if (this.clickNum > this.group - 1) {
                        this.timeStart = 0;
                        this.timeEnd = 1;
                        this.clickNum = 0;
                    }
                    },
                
                //“换一批”计数更新函数
                //每点击一次，记录次数
                autoIncre() {
                    this.clickNum++;
                    this.timeStart++;
                    this.timeEnd++;
                    },
                
                //“换一批”数据装载函数
                //截取元数据内当前每组的数据，放入新数组内
                interceptingData() {
                    this.buttons = this.buttonsStore.slice(
                        this.num * this.timeStart,
                        this.num * this.timeEnd
                        );
                    },

                //“换一批”快捷输入             
                fill(buttonText){
                    this.inputText=buttonText;
                    },
                
                //提交问题
                submit(){
                    // 阻止表单的默认提交行为
                    event.preventDefault();     
                    if (this.inputText !== '') {
                        this.messages.push({
                            id: Date.now(),
                            text: this.inputText,
                            imageUrl:'./picture/cat.png'
                            });
                    //调用发送函数
                    //置于if语句内避免空发送
                    this.sendMessage();
                        } 
                    },

                //显示回答文本
                displayResponseText(){
                    if (this.responseText !== '') {
                        this.messages.push({
                            id: Date.now(),
                            text: this.responseText,
                            imageUrl:'./picture/robot.png',
                            });
                        } 
                    },
/*
                //显示.md文本
                displayMarkdownText(){
                    if (this.markdownText !== '') {
                        this.mdTexts.push({
                            id: Date.now(),
                            text: this.markdownText,
                            });
                        } 
                    },

                //显示.md图片
                displayMarkdownImages(){
                    if (this.markdownImages.length > 0) {
                        for (const image of this.markdownImages) {
                            this.mdImage.push({
                                id: Date.now(),
                                text: this. basePath + image,
                                });
                            }
                        } 
                    },
*/

                // 显示.md文本和图片
                displayMarkdownContents() {
                if (this.markdownContents.length > 0) {
                    this.markdownContents.forEach(content => {
                        const newItem = {
                            id: Date.now(),
                            filename:content.file_name,
                            text: content.markdown_text,
                            image: content.markdown_images,
                            expanded: false // 添加 expanded 属性，默认为 false
                            };
                        this.mdContent.push(newItem);
                        this.mdFileCount=this.markdownContents.length;
                        });
                    }
                },

                //发送、接收数据
                sendMessage() {
                    //路由发送，定义方法、头部、数据
                    fetch('http://localhost:5000/receive.py', {
                        method: 'POST',
                        body: JSON.stringify({ text: this.inputText }),
                        headers: {
                        'Content-Type': 'application/json'
                        },
                        mode: 'cors',
                    })
                    .then(response => response.json())
                    .then(data => {
                        //数据回传后调用一系列方法处理数据
                        this.responseText = data.text;
                        this.markdownContents = data.markdown_contents;
                        this.displayResponseText();
                        this.displayMarkdownContents();
                    })
                    .catch(error => {
                        console.error('请求发送失败:', error);
                    });
                    //一切处理完毕后再清空inputText
                    //避免异步处理过程中数据无法读取
                    this.clearInputter();
                    },

                //清空inputText
                clearInputter(){
                    this.inputText = '';
                    },
                }
            }
        Vue.createApp(mydata).mount("#app")
    </script>
</html>